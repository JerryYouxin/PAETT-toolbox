# Prerequests

Before building PAETT tools, install several dependance listed below:

- C/C++ Compilers: gcc/g++
- x86_adapt
- x86_energy
- PAPI
- userspace governer (should be settled before installation)

# Build

PAETT libraries and tool applications can be built by make tools as follows.

~~~
$ cd PAETT-tool
$ make
~~~

The compiled executable tools are in `bin` directory, and libraries are in `lib` directory. 

# Usage

Compile the code with PAETT's clang/flang. We provide some wrapper scripts in `scripts` directory, where `paett-inst-*` is wrapper for PAETT's profiling instrumentation, and `paett-opt-*` is wrapper for PAETT's energy efficiency optimization.

To configure the profiling events of PAETT profiling, create/modify `profile.event` file in your executing path, all available PAPI events and energy collection `ENERGY` event (which utilizes x86_energy to collect energy profile for each region) can be configured. The generated profile can then be used to generate frequency commands by `freqcomm_gen` or list profiled CCT and significant regions by `paett_read_profile`.

Note that the frequency modification needs *root* privillage, all tuning procedure needs to be done in *root*. We recommend all tuning procedures are done in *root* user.

## Typical Workflow

1. We build the target program with our instrumentation pass. Here, we utilize our wrapped compile command `paett-inst-clang`:

```
# paett-inst-clang myapp.c -o myapp
```

2. (Optional) We need to detect all significant regions for further tuning to reduce the tuning overhead:

```
# export PAETT_ENABLE_FREQMOD=DISABLE
# export PAETT_DETECT_MODE=ENABLE
# ./myapp # Execute the program
```

3. (Optional) After significant region detection, we generate the filter file from profile and re-compile the target program with the generated filter:

```
# filter_gen --out paett.freqmod.filt --prof_fn libpaett_inst.log --keymap PAETT.keymap
# export PAETT_FILTER=paett.filt
# paett-inst-clang myapp.c -o myapp # re-compile with filter
```

4. (Optional 1) Tune with searching. PowerSpector provides some useful tool scripts `scripts/freq_search.py` for this propose:

```
# freq_search --run=./myapp --exaustive
```

5. (Optional 2) Or collect profiling data for model training, and get final frequency commands by prediction.

```
# python3 scripts/python_tools/frequency_predict.py --exe=./myapp --model=</path/to/model.pkl> --papi=<List,of,PAPI,counters>
```

6. Re-compile to contain frequency modification codes only for production usage:

```
# unset PAETT_FILTER
# export PAETT_CCT_FREQUENCY_COMMAND_FILTER=paett.freqmod.filt
# paett-inst-clang myapp.c -o myapp # re-compile with filter
```

7. Now execute with tuned frequency commands:

```
# export PAETT_ENABLE_FREQMOD=ENABLE
# export PAETT_CCT_FREQUENCY_COMMAND_FILE=frequency_command.cct
# ./myapp
```

# PAETT Environment Variables

Used by profiling with `libpaett_inst`:
- `PAETT_OUTPUT_PATH`: the path to PAETT's profiling output file
- `PAETT_DETECT_MODE`: set to `ENABLE` to enable PAETT's detection mode of significant region, which only collects executing time of each CCT. The result file is generated as `PAETT_DETECT_RES_PATH` or default file name `libpaett_inst.log`. The generated file can then used as input of `filter_gen` tool to generate filter for PAETT's compiler plugin for lower profiling overhead.
- `PAETT_DETECT_RES_PATH`: the path to PAETT's generated file by PAETT's detection mode. If `PAETT_DETECT_MODE` is set to `ENABLE`, this configures the path of the output file.
- `PAETT_ENABLE_FREQMOD`: enable frequency modification with frequency commands defined in `PAETT_CCT_FREQUENCY_COMMAND_FILE`
- `PAETT_PROFILE_EVENTS`: PAPI events, or energy collection "ENERGY". Each event is seperated by `;`, e.g. `ENERGY;PAPI_LD_INS`

Used by PAETT compiler instrumentation plugin (`paett-inst-*`):
- `PAETT_FILTER`: the path to filter file, which is generated by `filter_gen` tool. Each line in this filter file is PAETT's annotated debug information and only the regions listed in this filter file will be instrumented.
- `PAETT_CCT_FREQUENCY_COMMAND_FILTER`: the path to CCT-aware frequency command filter, which is generated by `freqcomm_gen` tool.

`-paett_frequency_command_file=<path/to/file>`: command line option to configure the path to PAETT's generated frequency command file.

# How to change to `userspace` for linux

## Disable `intel_pstate` driver

in /etc/default/grub, change lines like following:

```
GRUB_CMDLINE_LINUX="quiet"
```

to

```
GRUB_CMDLINE_LINUX="quiet intel_pstate=disable"
```

then run command:

```
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
sudo grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg
sudo grub2-mkconfig -o /boot/grub/grub.cfg
sudo reboot
```

after reboot, then acpi-cpufreq driver will be used.

## Change to userspace

```
sudo cpufreq-set -g userspace
```